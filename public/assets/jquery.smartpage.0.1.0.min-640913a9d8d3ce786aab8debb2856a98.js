/**
 * jQuery SmartPage v0.1.0 - page smart change plugin
 *
 * Terms of Use - jQuery SmartPage
 * under the MIT (http://www.opensource.org/licenses/mit-license.php) License.
 *
 * Copyright 2011 xlune.com All rights reserved.
 * (http://blog.xlune.com/2011/05/jquerysmartpage.html)
 */
!function(t){t.fn.smartPage=function(e){var n={endPoint:location.protocol+"//"+location.hostname+"/",fixedEndPoint:!1,fragment:"#!",useFade:!1,useCSSFade:!1,useScrollTop:!1,useHash:!1,useHistoryState:!1,useIE9:!1,useFragmentClear:!0,onStart:null,onChange:null,onComplete:null,onScriptComplete:null,onError:null,pageRules:[],baseList:[],insertList:[],scriptDelay:100},a={isInit_:!1,state_:null,hash_:null,hashTimer_:null,deferred_:null,task_:[]},o={CANCEL:"cancel"},r={},i={init:function(e){var o=this;return r=t.extend({},n,e,a),s.isNotIE()||r.useIE9&&s.getIEVersion()>=9?("function"!=typeof history.pushState&&(r.useHistoryState=!1),r.fixedEndPoint&&r.useHash&&!r.useHistoryState&&s.checkPath(s.getUrl())&&(e=s.getPathName(s.getUrl()),s.getUrl().replace(/#.*$/gi,"")!==r.endPoint&&location.replace(r.endPoint+r.fragment+e)),(r.useHash||r.useHistoryState)&&(r.useHistoryState?(r.state_=location.href,s.setStateChangeEvent(),r.useFragmentClear&&s.replaceClearHash()):(r.fragment.match(/^#/)||(r.fragment="#"+r.fragment),s.setHashChangeEvent(),s.hashChangeHandler()),t(function(){s.setClickEvents(o)}))):r.useFragmentClear&&s.replaceClearHash(),o.each(function(){t(o)})},getUrl:function(){if(r.useHistoryState)return[location.protocol,"//",location.hostname,location.pathname,encodeURI(location.search).replace(/'/g,"%27"),encodeURI(location.hash).replace(/'/g,"%27")].join("");var t=RegExp(r.fragment+"/?");return(s.getBasePoint()+r.hash_).replace(t,"")}},s={setClickEvents:function(e){t(e).find("a, area").live("click",s.clickHandler)},clickHandler:function(e){var n=t(e.target).attr("href");return n&&(n=s.getFullPath(n),s.checkPath(n))?(r.useHistoryState?n!==r.state_&&(history.pushState({},s.getTitle(),n),s.load(n)):(n=s.getPathName(n),location.hash=r.fragment+n),e.preventDefault(),!1):!0},getTitle:function(){return document.title},getUrl:function(){return s.escapeHtmlSpecialCharacters(location.href)},getFullPath:function(t){var e=s.getUrl().replace(/[#?].*$/gi,"").replace(/\/[^\/]*$/,"/");switch(!0){case/^https?:\/\//.test(t):break;case/^\//.test(t):t=location.protocol+"//"+location.hostname+t;break;default:for(;;)if(/^.\//.test(t))t=t.replace(/^.\//,"");else{if(!/^..\//.test(t)){t=e+t;break}t=t.replace(/^..\//,""),e.match(/\//g).length>3&&(e=e.replace(/[^\/]*\/$/,""))}}return t},checkPath:function(t){if(r.pageRules instanceof Array){var e,n=r.pageRules.concat();if(!n.length){var a=s.escapeRegExpSpecialCharacters(r.endPoint);n.push(RegExp("^"+a,"i"))}for(e in n)if(!(n[e][0]instanceof RegExp&&n[e][0].test(t)===n[e][1]))return!1;return!0}return!1},getPathName:function(t){return t.replace(s.getBasePoint(),"")},getHashKey:function(){return location.hash.replace(RegExp("^"+r.fragment),"")},getBasePoint:function(){return r.endPoint.replace(/\/$/,"")},isNotIE:function(){return!0},getIEVersion:function(){for(var t=3,e=document.createElement("div"),n=e.getElementsByTagName("i");e.innerHTML="<!--[if gt IE "+ ++t+"]><i></i><![endif]-->",n[0];);return t>4?t:null},replaceClearHash:function(){var t=RegExp(r.fragment+"/?","g");t.test(location.href)&&(r.useHistoryState?(t=location.href.replace(t,""),history.replaceState({},null,t),s.load(t)):location.replace(location.href.replace(t,"")))},load:function(e){r.state_=e,r.isInit_=!0,r.deferred_&&r.deferred_.abort(o.CANCEL),"function"==typeof r.onStart&&r.onStart(),r.deferred_=t.get(e).then(s.loadComplete,s.loadError)},loadCompleteTask:function(){r.task_.length>0?r.task_.shift()():"function"==typeof r.onScriptComplete&&r.onScriptComplete()},loadCompleteChange:function(){"function"==typeof r.onChange&&r.onChange()},loadCompleteFinish:function(){"function"==typeof r.onComplete&&r.onComplete(),s.loadCompleteTask(),r.useScrollTop&&s.scrollTop()},loadError:function(e,n){n!==o.CANCEL&&(t.error("page load error"),"function"==typeof r.onError)&&r.onError()},loadComplete:function(e){var n,a,o,i,c,l,u=r.baseList,p=r.insertList;n=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;var h=e.match(n);a=function(t){return function(){return"<!--%%smartpage-script"+(t++).toString()+"%%-->"}}(0);var f=document.write,d=document.writeln;r.task_=[];var g=t("<div />").append(e.replace(n,a));if(u instanceof Array)for(n=0,a=Math.min(u.length,p.length);a>n;n++){for(c=t(u[n]),p[n]?(o=g.find(p[n]),o.each(function(e){var n;if(e=t(c.get(e)))for(n in this.attributes)e.attr(this.attributes[n].nodeName,this.attributes[n].nodeValue)}),l=o.html()):l=e,o=0,i=h.length;i>o;o++)l.match("<!--%%smartpage-script"+o+"%%-->")&&(l=l.replace("<!--%%smartpage-script"+o+"%%-->",'<div id="smartpage-script'+o.toString()+'" style="position: static !important; border:none !important; margin:0 !important; padding:0 !important; background:none !important;"> </div>'),r.task_.push(function(e,n,a){return function(){var n=t("#"+e);if(n.size()>0){var o,i,c=r.scriptDelay,l=t(a),u=!1,p=function(){u||(document.write=f,document.writeln=d,s.loadCompleteTask())},h=function(){u&&(u=!1,clearTimeout(o),o=setTimeout(p,c))};document.write=function(t){n.get(0).innerHTML+=t,clearTimeout(o),o=setTimeout(p,c)},document.writeln=function(t){t+="\r\n",n.get(0).innerHTML+=t,clearTimeout(o),o=setTimeout(p,c)},(i=l.attr("src"))?(u=!0,l=document.createElement("script"),l.src=i,l.onload=h,l.onreadystatechange=function(){("loaded"==this.readyState||"complete"==this.readyState)&&h()},n.get(0).appendChild(l)):(clearTimeout(o),o=setTimeout(p,c),n.html(l))}else s.loadCompleteTask()}}("smartpage-script"+o.toString(),o,h[o])));s.setFadeAction(c,l,n)}},setCSSFade:function(t,e,n){e=isNaN(e)?0:e,n=isNaN(n)?0:n,t.css({"-webkit-transition-property":"opacity","-webkit-transition-duration":n.toString()+"s","-webkit-transition-timing-function":"ease-out","-moz-transition-property":"opacity","-moz-transition-duration":n.toString()+"s","-moz-transition-timing-function":"ease-out","transition-property":"opacity","transition-duration":n.toString()+"s","transition-timing-function":"ease-out",opacity:e})},setFadeAction:function(e,n,a){!r.useCSSFade||"undefined"==typeof t("html").css("-webkit-transition-property")&&"undefined"==typeof t("html").css("-moz-transition-property")&&"undefined"==typeof t("html").css("transition-property")?e.stop().fadeTo(r.useFade?300:1,.01,function(t,e,n){return function(){t.html(e),0==n&&s.loadCompleteChange()}}(e,n,a)).fadeTo(r.useFade?300:1,1,function(t){return function(){0==t&&s.loadCompleteFinish()}}(a)):(clearTimeout(e.data("smartpage-timer")),s.setCSSFade(e,0,.3),e.data("smartpage-timer",setTimeout(function(t,e,n){return function(){t.html(e),0==n&&s.loadCompleteChange(),clearTimeout(t.data("smartpage-timer")),s.setCSSFade(t,1,.3),t.data("smartpage-timer",setTimeout(function(t,e,n){return function(){0==n&&s.loadCompleteFinish()}}(t,e,n),300))}}(e,n,a),300)))},scrollTop:function(){var e=t(window);t("head").stop().css({position:"fixed",top:e.scrollTop()+"px"}).animate({top:0},{duration:500,easing:"linear",step:function(t){e.scrollTop(t)}})},setStateChangeEvent:function(){t(window).unbind("popstate",s.stateChangeHandler),t(window).bind("popstate",s.stateChangeHandler)},stateChangeHandler:function(){r.isInit_&&s.load(location.href),r.isInit_=!0},setHashChangeEvent:function(){"onhashchange"in window?(t(window).unbind("hashchange",s.hashChangeHandler),t(window).bind("hashchange",s.hashChangeHandler)):(clearInterval(r.hashTimer_),r.hashTimer_=setInterval(function(t){return function(){s.hashChangeHandler.apply(t)}}(this),500))},hashChangeHandler:function(){var t;r.hash_!==(t=s.getHashKey())&&(r.hash_=t,r.isInit_&&s.load(s.getBasePoint()+t),r.isInit_=!0)},escapeRegExpSpecialCharacters:function(t){return t.replace(/(\\|\/|\^|\$|\*|\+|\?|\{|\||\}|\[|\])/g,"\\$1")},escapeHtmlSpecialCharacters:function(t){var e,n,a=[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"],[/"/g,"&quot;"],[/'/g,"&#039;"]];for(e=0,n=a.length;n>e;e++)t=t.replace(a[e][0],a[e][1]);return t},delay:function(e){return e=isNaN(e)?0:e,t.Deferred(function(t){setTimeout(t.resolve,1e3*e)}).promise()}};return i[e]?i[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?(t.error('Method "'+e+'" does not exist in smartPage plugin!'),void 0):i.init.apply(this,arguments)}}(jQuery);